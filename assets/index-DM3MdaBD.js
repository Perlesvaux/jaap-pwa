var V=Object.defineProperty;var X=(n,e,a)=>e in n?V(n,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[e]=a;var N=(n,e,a)=>X(n,typeof e!="symbol"?e+"":e,a);import{csvParse as ee,csvFormat as te}from"https://cdn.jsdelivr.net/npm/d3-dsv@3/+esm";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function a(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerPolicy&&(r.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?r.credentials="include":t.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(t){if(t.ep)return;t.ep=!0;const r=a(t);fetch(t.href,r)}})();function k(n,e){const a={};for(const s of n.elements){const{name:t,id:r,type:o,value:l}=s;if(!(!t&&!r)){if(e!=null&&e.includes(t)||e!=null&&e.includes(r)){a[t||r]=l;continue}switch(o){case"date":case"datetime-local":case"month":const i=new Date(l);i.setMinutes(i.getMinutes()+i.getTimezoneOffset()),a[t||r]=i.valueOf();break;case"number":case"range":a[t||r]=Number(l);break;case"text":a[t||r]=l.trim();break;default:a[t||r]=l}}}return a}class v{constructor(e,a,s){this.show_btn=e,this.table=a,this.searchbox=s,this.show_btn.addEventListener("click",()=>{for(const t of this.constructor.instances){if(t===this){t.show_btn.classList.add("active-section"),t.table.hidden=!1,t.searchbox.hidden=!1;continue}t.show_btn.classList.remove("active-section"),t.table.hidden=!0,t.searchbox.hidden=!0}},{passive:!0}),this.constructor.instances.push(this)}}N(v,"instances",[]);function F(n,e,a){n.textContent="";for(const s of a){const t=g(s).replaceAll(" ","-").toLowerCase(),r=t.concat(Math.random()),o=document.createElement("input");o.setAttribute("type","checkbox"),o.setAttribute("checked",""),o.setAttribute("id",r),o.setAttribute("data-class",t),o.addEventListener("change",i=>{const d=i.target.getAttribute("data-class"),u=e.querySelectorAll(`[data-class=${d}]`);for(const m of u)m.hidden=!m.hidden},{passive:!0});const l=document.createElement("label");l.setAttribute("for",r),l.textContent=s.replaceAll("_"," "),n.append(o,l)}}function z(n,e,a){n.textContent="";const s=n.createTHead().insertRow();for(const r of a){const o=document.createElement("th");o.setAttribute("data-class",g(r).replaceAll(" ","-")),o.setAttribute("data-row-order","default"),o.textContent=r.replaceAll("_"," "),s.appendChild(o)}const t=n.createTBody();for(const r of e){const o=t.insertRow();for(const l of a){const i=o.insertCell();i.setAttribute("data-class",g(l).replaceAll(" ","-"));let d=r[l];i.setAttribute("data-value",d);const u=new Date(d);typeof d=="number"&&d.toString().length===13&&!isNaN(u)&&(d=u.toLocaleDateString("es",{day:"numeric",year:"numeric",month:"short",timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone})),i.textContent=d}}}function J(n,e){const a=g(e.target.value).toLowerCase(),s=n.tBodies[0];if(s)for(const t of s.rows){const r=g(Array.from(t.cells).map(o=>o.textContent).join(" ")).toLowerCase();t.hidden=!r.includes(a)}}function P(n){console.error(n),alert("Ha ocurrido un error, abra la consola para más detalles!")}function g(n){return n.replaceAll(/[áéíóúñ]/g,e=>{switch(e){case"á":return"a";case"é":return"e";case"í":return"i";case"ó":return"o";case"ú":return"u";case"ñ":return"n";case"Á":return"A";case"É":return"E";case"Í":return"I";case"Ó":return"O";case"Ú":return"U";case"Ñ":return"N"}})}let A=JSON.parse(localStorage.getItem("meters"));Array.isArray(A)&&!Array.isArray(A[0])&&localStorage.clear();A=null;if("serviceWorker"in navigator)try{navigator.serviceWorker.register("./service-worker.js")}catch(n){console.error(`Your browser seems to support service workers, but the registration of this app's worker failed with error: ${n}`)}else console.error("This app's service worker couldn't be installed because you're in Private Mode or your browser doesn't support service workers!");const re=document.getElementById("meters-section"),ne=document.getElementById("csv-section"),ae=document.getElementById("help-section"),C=document.getElementById("num-recibo"),oe=document.getElementById("set-receipt-btn"),se=document.getElementById("err-num-recibo"),Z=document.getElementById("num-first-receipt"),L=document.getElementById("num-next-receipt"),ce=document.getElementById("total-medidores"),M=document.getElementById("receipts"),de=document.getElementById("print-all-btn"),h=document.getElementById("history"),f=document.getElementById("meters-table"),ie=document.getElementById("meters-switches"),H=document.getElementById("meter-search"),j=document.getElementById("cell-options"),le=document.getElementById("no-print-f"),I=document.getElementById("meter-add-btn"),$=document.getElementById("meter-form"),ue=document.getElementById("meter-error-form"),me=document.getElementById("meter-repeated"),fe=document.getElementById("meter-filter"),_e=document.getElementById("meter-added-form"),B=document.getElementById("reading-btn"),K=document.getElementById("reading-form"),D=document.getElementById("read-confirm-form"),be=document.getElementById("meter-non-existant-form"),pe=document.getElementById("non-existant-meter"),ge=document.getElementById("meter-already-read-form"),ye=document.querySelectorAll(".already-read-meter"),T=document.getElementById("err-desde-hasta"),R=document.getElementById("err-lecturas"),he=document.getElementById("suggested-caseríos"),we=document.getElementById("suggested-meters"),c={current:{key:null,data:null},last:{key:null,data:null}};document.getElementById("meter-being-read");document.getElementById("meter-reading");const Ee=document.getElementById("fecha-lectura-actual"),ve=document.getElementById("fees-section"),w=document.getElementById("fees-table"),xe=document.getElementById("fees-search"),E=document.getElementById("csv-table"),Ae=document.getElementById("csv-btn"),W=document.getElementById("csv-filter"),Ie=document.getElementById("csv-switches"),Y=document.getElementById("csv-search"),y={current:{data:null}},Be=document.getElementById("user-guide"),ke=document.getElementById("help-search"),Ce=document.getElementById("export-meters-csv"),Le=document.getElementById("export-meters-json"),Se=24*60*60*1e3,Oe=document.getElementById("receipt-template"),S=indexedDB.open("meters",1);let p=null,O=null;S.onerror=P;S.onupgradeneeded=n=>{localStorage.setItem("fees",JSON.stringify([{mínimo:0,máximo:6,fórmula:"2.61"},{mínimo:7,máximo:40,fórmula:"0.25 * consumo + 1.60"},{mínimo:41,máximo:50,fórmula:"0.40 * (consumo - 40) + 10 + 1.60"},{mínimo:51,máximo:100,fórmula:"0.75 * consumo + 1.60"},{mínimo:101,máximo:150,fórmula:"1.00 * consumo + 1.60"},{mínimo:151,máximo:200,fórmula:"1.25 * consumo + 1.60"},{mínimo:201,máximo:null,fórmula:"1.50 * consumo + 1.60"}])),n.target.result.createObjectStore("meters",{autoIncrement:!0}).add([])};S.onsuccess=n=>{p=n.target.result,p.onversionchange=()=>{p.close(),alert("La base de datos está desactualizada! Por favor recargue la app o ciérrela y vuélvala a abrir.")},p.onerror=P,Q(),O=JSON.parse(localStorage.getItem("fees")),Me(["mínimo","máximo","fórmula"])};let b=JSON.parse(localStorage.getItem("receipt"))??{};Z.textContent=b.first??"indefinido";L.textContent=b.next??"indefinido";oe.addEventListener("click",()=>{if(c.last.data.some(e=>typeof e.recibo=="number")||c.current.data.some(e=>typeof e.recibo=="number")){se.parentElement.showModal();return}C.parentElement.showModal()});h.addEventListener("change",n=>{c.current.key=Number(n.target.value);const e=p.transaction("meters","readonly").objectStore("meters").get(c.current.key);e.onsuccess=a=>{c.current.key===c.last.key&&(c.last.data=a.target.result),c.current.data=a.target.result;const s=["medidor","zona","titular","caserío","lectura_anterior","desde","lectura_actual","hasta","recibo"];z(f,c.current.data,s),F(ie,f,s),je(),Ne(),ce.textContent=f.tBodies[0].rows.length,c.current.key!==c.last.key?(I.setAttribute("disabled",""),B.setAttribute("disabled",""),f.tBodies[0].classList.add("non-first")):(I.removeAttribute("disabled"),B.removeAttribute("disabled"),f.tBodies[0].classList.remove("non-first")),M.textContent="";for(const t of c.current.data){if(t.recibo===void 0)continue;const r=Oe.content.cloneNode(!0),o=r.querySelectorAll("[data-field]");for(const d of o)switch(d.getAttribute("data-field")){case"nombre":d.textContent=t.titular;break;case"caserio":d.textContent=t.caserío;break;case"recibo":d.textContent=t.recibo;break;case"medidor":d.textContent=t.medidor;break;case"zona":d.textContent=t.zona;break;case"desde":d.textContent=new Date(t.desde).toLocaleDateString("es",{day:"numeric",year:"numeric",month:"short",timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone});break;case"hasta":d.textContent=new Date(t.hasta).toLocaleDateString("es",{day:"numeric",year:"numeric",month:"short",timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone});break;case"lectura_anterior":d.textContent=t.lectura_anterior;break;case"lectura_actual":d.textContent=t.lectura_actual;break;case"cubre":d.textContent=(t.hasta-t.desde)/Se;break;case"consumo":d.textContent=t.lectura_actual-t.lectura_anterior;break;case"cargo":const u=t.lectura_actual-t.lectura_anterior,m=O.find(x=>x.mínimo<=u&&u<=(x.máximo??1e6)).fórmula,_=new Function("consumo",`return ${m}`);d.textContent=_(u).toFixed(2);break;case"multa":d.textContent=1.15;break}const l=document.createElement("article"),i=document.createElement("hr");l.append(r,i,r.cloneNode(!0)),M.append(l)}}},{passive:!0});I.addEventListener("click",()=>{if(typeof b.next=="number"){G(he,"caserío"),$.parentElement.showModal();return}C.parentElement.showModal()},{passive:!0});C.addEventListener("submit",n=>{const e=k(n.target).first_receipt;b={first:e,next:e},localStorage.setItem("receipt",JSON.stringify(b)),Z.textContent=b.first,L.textContent=b.next},{passive:!0});new v(ae,Be,ke);$.addEventListener("submit",n=>{const e=k(n.target,["medidor"]);if(c.last.data.find(t=>t.medidor===e.medidor)){me.textContent=e.medidor,ue.parentElement.showModal();return}e.lectura_actual=void 0,e.hasta=void 0,c.last.data.push(e);const s=p.transaction("meters","readwrite").objectStore("meters").put(c.last.data,c.last.key);s.onsuccess=()=>{_e.parentElement.showModal(),h.dispatchEvent(new Event("change"))}},{passive:!0});fe.addEventListener("input",n=>J(f,n),{passive:!0});new v(re,f,H);B.addEventListener("click",()=>{G(we,"medidor"),Ee.value=new Date().toLocaleDateString("en-ca"),K.parentElement.showModal()},{passive:!0});K.addEventListener("submit",n=>{const e=k(n.target,["medidor"]),a=c.last.data.find(r=>r.medidor===e.medidor);if(!a){pe.textContent=e.medidor,be.parentElement.showModal();return}if(typeof a.lectura_actual!="number"){if(a.desde>=e.hasta){T.parentElement.showModal();return}if(a.lectura_anterior>e.lectura_actual){R.parentElement.showModal();return}a.lectura_actual=e.lectura_actual,a.hasta=e.hasta,a.recibo=q();const r=p.transaction("meters","readwrite").objectStore("meters").put(c.last.data,c.last.key);r.onsuccess=()=>{D.parentElement.showModal(),c.current.key===c.last.key&&h.dispatchEvent(new Event("change"))};return}if(c.last.data.every(r=>r.lectura_actual)){if(a.hasta>=e.hasta){T.parentElement.showModal();return}if(a.lectura_actual>e.lectura_actual){R.parentElement.showModal();return}const r=[];for(const l of c.last.data){const{medidor:i,zona:d,titular:u,caserío:m,lectura_actual:_,hasta:x}=l,U={medidor:i,zona:d,titular:u,caserío:m,lectura_anterior:_,desde:x,lectura_actual:e.medidor===i?e.lectura_actual:void 0,hasta:e.medidor===i?e.hasta:void 0,recibo:e.medidor===i?q():void 0};r.push(U)}const o=p.transaction("meters","readwrite").objectStore("meters").add(r);o.onsuccess=()=>{Q(),D.parentElement.showModal()}}else{for(const r of ye)r.textContent=e.medidor;ge.parentElement.showModal()}});new v(ne,E,Y);Ae.addEventListener("change",n=>{const e=n.currentTarget.files[0];if(!e)return;const a=new FileReader;a.onload=function(s){y.current.data=ee(s.target.result),delete y.current.data.columns;const t=Object.keys(y.current.data[0]);z(E,y.current.data,t),F(Ie,E,t),f.hidden=!0,H.hidden=!0,E.hidden=!1,Y.hidden=!1,W.disabled=!1},a.readAsText(e)});W.addEventListener("input",n=>J(E,n),{passive:!0});Ce.addEventListener("click",()=>{const n=te(f.hidden?y.current.data:c.current.data),e=document.createElement("a");e.href=URL.createObjectURL(new Blob([n],{type:"text/csv",endings:"native"})),e.download="tabla.csv",e.click(),URL.revokeObjectURL(e.href)},{passive:!0});Le.addEventListener("click",()=>{const n=JSON.stringify(f.hidden?y.current.data:c.current.data,null,3),e=document.createElement("a");e.href=URL.createObjectURL(new Blob([n],{type:"application/json"})),e.download="tabla.json",e.click(),URL.revokeObjectURL(e.href)},{passive:!0});new v(ve,w,xe);de.addEventListener("click",()=>{c.current.data.some(n=>n.recibo===void 0)?le.parentElement.showModal():print()});function Ne(){f.tBodies[0].addEventListener("click",e=>{const a=e.target.textContent,s=Array.from(e.target.parentElement.cells),t=s.map(o=>o.textContent).join(" ");e.target.getAttribute("data-class");const r=s.find(o=>o.getAttribute("data-class")==="medidor").getAttribute("data-value");c.current.data.find(o=>o.medidor===r),j.addEventListener("submit",o=>{switch(o.submitter.name){case"copy-cell":navigator.clipboard.writeText(a);break;case"copy-row":navigator.clipboard.writeText(t);break}},{passive:!0}),j.parentElement.showModal()},{passive:!0})}function Me(n){w.textContent="";const e=w.createCaption(),a=document.createElement("sup");a.textContent=3,e.append(document.createTextNode("Fórmulas según el consumo en m"),a);const s=w.createTHead().insertRow();for(const r of n){const o=document.createElement("th");o.setAttribute("data-class",g(r).replaceAll(" ","-")),o.setAttribute("data-row-order","default"),o.textContent=r.replaceAll("_"," "),s.appendChild(o)}const t=w.createTBody();for(const r of O){const o=t.insertRow();for(const l of n){const i=o.insertCell();i.setAttribute("data-class",g(l).replaceAll(" ","-"));const d=r[l];i.setAttribute("data-value",d),i.textContent=d}}}function je(){var t;const n=(t=f.tHead.rows[0])==null?void 0:t.children,e=f.tBodies[0],a=Array.from(e.rows),s={medidor:"string",zona:"number",titular:"string",caserio:"string",lectura_anterior:"number",desde:"number",lectura_actual:"number",hasta:"number",recibo:"number"};for(const r of n){r.setAttribute("data-row-order","default");const o=r.getAttribute("data-class"),l=s[o];l==="number"?r.addEventListener("click",()=>{r.getAttribute("data-row-order")==="ascending"?r.setAttribute("data-row-order","descending"):r.setAttribute("data-row-order","ascending"),a.sort((i,d)=>{let u=Number(Array.from(i.cells).find(_=>_.getAttribute("data-class")===o).getAttribute("data-value")),m=Number(Array.from(d.cells).find(_=>_.getAttribute("data-class")===o).getAttribute("data-value"));return isNaN(u)&&(u=0),isNaN(m)&&(m=0),r.getAttribute("data-row-order")==="ascending"?u-m:m-u}),e.textContent="",e.append(...a)}):l==="string"&&r.addEventListener("click",()=>{r.getAttribute("data-row-order")==="ascending"?r.setAttribute("data-row-order","descending"):r.setAttribute("data-row-order","ascending"),a.sort((i,d)=>{let u=Array.from(i.cells).find(_=>_.getAttribute("data-class")===o).getAttribute("data-value"),m=Array.from(d.cells).find(_=>_.getAttribute("data-class")===o).getAttribute("data-value");return u=u?u.toLowerCase():"",m=m?m.toLowerCase():"",u<m?r.getAttribute("data-row-order")==="ascending"?-1:1:u>m?r.getAttribute("data-row-order")==="ascending"?1:-1:0}),e.textContent="",e.append(...a)})}}function q(){const n=b.next;return L.textContent=++b.next,localStorage.setItem("receipt",JSON.stringify(b)),n}function G(n,e){n.textContent="";const a=new Set(c.last.data.map(s=>s[e]));for(const s of a){const t=document.createElement("option");t.value=s,n.append(t)}}function Q(){const n=p.transaction("meters","readonly").objectStore("meters").getAllKeys();n.onsuccess=e=>{const a=e.target.result,s=c.last.key;c.last.key=a.at(-1),h.textContent="";for(const t of a){const r=document.createElement("option");r.value=t,r.textContent=t,(t===c.current.key||t===c.last.key)&&r.setAttribute("selected",""),h.prepend(r)}s!==c.last.key&&h.dispatchEvent(new Event("change"))}}
